{% load static %}
<form id="prescription-form">
  <div id="medicines-container">
    <div class="medicine-entry row g-3 mb-2">
      <div class="col-md-3">
        <label class="form-label">Medicine *</label>
        <input type="text" class="form-control" name="medicine" required>
      </div>
      <div class="col-md-2">
        <label class="form-label">Dosage *</label>
        <input type="number" class="form-control" name="dosage" required>
      </div>
      <div class="col-md-2">
        <label class="form-label">&nbsp;</label>
        <select class="form-select" name="dosage_unit">
          <option value="Tablet(s)">Tablet(s)</option>
          <option value="Capsule(s)">Capsule(s)</option>
          <option value="ml">ml</option>
        </select>
      </div>
      <div class="col-md-2">
        <label class="form-label">No. of Days *</label>
        <input type="number" class="form-control" name="num_days" required>
      </div>
      <div class="col-md-1">
        <label class="form-label">&nbsp;</label>
        <select class="form-select" name="num_days_unit">
          <option value="Day">Day</option>
          <option value="Week">Week</option>
        </select>
      </div>
      <div class="col-md-2">
        <label class="form-label">Frequency *</label>
        <select class="form-select" name="frequency" required>
          <option value="1 time a day">1 time a day</option>
          <option value="2 times a day">2 times a day</option>
          <option value="3 times a day">3 times a day</option>
        </select>
      </div>
      <div class="col-md-2">
        <label class="form-label">Food Relation</label>
        <select class="form-select" name="food_relation">
          <option value="">--</option>
          <option value="Before food">Before food</option>
          <option value="After food">After food</option>
        </select>
      </div>
      <div class="col-md-1 d-flex align-items-end">
        <button type="button" class="btn btn-danger btn-remove-medicine" style="display:none;">&minus;</button>
      </div>
    </div>
  </div>
  <div class="mb-2">
    <button type="button" class="btn btn-success" id="add-medicine-btn">+ Add Medicine</button>
  </div>
  <div class="mb-3">
    <label for="diagnosis" class="form-label">Diagnosis / Doctor's Notes</label>
    <textarea class="form-control" id="diagnosis" name="diagnosis" rows="2"></textarea>
  </div>
  <div class="d-flex justify-content-end">
    <button type="submit" class="btn btn-primary" id="send-prescription-btn">Send</button>
  </div>
</form>
<script>
function getMedicineEntryHtml() {
  return `<div class=\"medicine-entry row g-3 mb-2\">
    <div class=\"col-md-3\">
      <input type=\"text\" class=\"form-control\" name=\"medicine\" required placeholder=\"Medicine\">
    </div>
    <div class=\"col-md-2\">
      <input type=\"number\" class=\"form-control\" name=\"dosage\" required placeholder=\"Dosage\">
    </div>
    <div class=\"col-md-2\">
      <select class=\"form-select\" name=\"dosage_unit\">
        <option value=\"Tablet(s)\">Tablet(s)</option>
        <option value=\"Capsule(s)\">Capsule(s)</option>
        <option value=\"ml\">ml</option>
      </select>
    </div>
    <div class=\"col-md-2\">
      <input type=\"number\" class=\"form-control\" name=\"num_days\" required placeholder=\"No. of Days\">
    </div>
    <div class=\"col-md-1\">
      <select class=\"form-select\" name=\"num_days_unit\">
        <option value=\"Day\">Day</option>
        <option value=\"Week\">Week</option>
      </select>
    </div>
    <div class=\"col-md-2\">
      <select class=\"form-select\" name=\"frequency\" required>
        <option value=\"1 time a day\">1 time a day</option>
        <option value=\"2 times a day\">2 times a day</option>
        <option value=\"3 times a day\">3 times a day</option>
      </select>
    </div>
    <div class=\"col-md-2\">
      <select class=\"form-select\" name=\"food_relation\">
        <option value=\"\">--</option>
        <option value=\"Before food\">Before food</option>
        <option value=\"After food\">After food</option>
      </select>
    </div>
    <div class=\"col-md-1 d-flex align-items-end\">
      <button type=\"button\" class=\"btn btn-danger btn-remove-medicine\">&minus;</button>
    </div>
  </div>`;
}

document.getElementById('add-medicine-btn').onclick = function() {
  var container = document.getElementById('medicines-container');
  var newEntry = document.createElement('div');
  newEntry.innerHTML = getMedicineEntryHtml();
  container.appendChild(newEntry.firstChild);
  updateRemoveButtons();
};

function updateRemoveButtons() {
  var entries = document.querySelectorAll('.medicine-entry');
  entries.forEach(function(entry, idx) {
    var btn = entry.querySelector('.btn-remove-medicine');
    if (btn) {
      btn.style.display = (entries.length > 1) ? '' : 'none';
      btn.onclick = function() {
        entry.remove();
        updateRemoveButtons();
      };
    }
  });
}
updateRemoveButtons();

document.getElementById('prescription-form').onsubmit = function(e) {
  e.preventDefault();
  var form = this;
  var formData = new FormData();
  // Gather all medicine entries
  var entries = document.querySelectorAll('.medicine-entry');
  entries.forEach(function(entry, idx) {
    formData.append('medicine', entry.querySelector('[name="medicine"]').value);
    formData.append('dosage', entry.querySelector('[name="dosage"]').value);
    formData.append('dosage_unit', entry.querySelector('[name="dosage_unit"]').value);
    formData.append('num_days', entry.querySelector('[name="num_days"]').value);
    formData.append('num_days_unit', entry.querySelector('[name="num_days_unit"]').value);
    formData.append('frequency', entry.querySelector('[name="frequency"]').value);
    formData.append('food_relation', entry.querySelector('[name="food_relation"]').value);
  });
  // Add diagnosis
  formData.append('diagnosis', document.getElementById('diagnosis').value);
  fetch(window.location.href, {
    method: 'POST',
    body: formData,
    headers: { 'X-Requested-With': 'XMLHttpRequest' }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      alert(data.message);
      if (window.parent && window.parent.location) {
        window.parent.location.reload();
      } else {
        window.location.reload();
      }
    } else {
      alert('Failed to send prescription.');
    }
  });
};
</script> 