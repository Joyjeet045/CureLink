{% extends "base.html" %}

{% block content %}
<style>
  .appointment {
    background-color: #f5f5f5;
    border: 1px solid #ccc;
    margin-bottom: 10px;
    padding: 10px;
    border-radius: 5px;
  }

  .appointment a {
    text-decoration: none;
    color: #007BFF;
    margin-left: 10px;
  }

  .alert {
    margin-top: 20px;
  }

  /* Green color for True and Red for False */
  .status-true {
    color: green;
  }

  .status-false {
    color: red;
  }
  .status-past {
    color: #dc3545;
    font-weight: bold;
  }
  .no-doctors-message {
    font-size: 18px;
    color: #FF0000; 
    text-align: center;
    margin-top: 20px;
    font-weight: bold;
  }
  .modal {
  z-index: 1050 !important;
  }

  .modal-backdrop {
    z-index: 1040 !important;
  }

  /* Fix modal content scrolling */
  .modal-dialog {
    max-height: 90vh;
    overflow-y: auto;
  }

  /* Ensure form elements are properly styled and not disabled */
  .modal .form-control,
  .modal .form-select {
    background-color: #fff !important;
    border: 1px solid #ced4da !important;
    opacity: 1 !important;
    pointer-events: auto !important;
  }

  /* Fix button states */
  .modal .btn {
    pointer-events: auto !important;
    opacity: 1 !important;
  }

  /* Ensure modal body content is scrollable */
  .modal-body {
    max-height: 70vh;
    overflow-y: auto;
  }

  /* Fix prescription form specific styling */
  #prescription-modal-body {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 24px;
  }
  #prescription-content h6 {
    margin-top: 18px;
    font-weight: 600;
    color: #2c3e50;
  }
  #prescription-medicines-list {
    list-style: none;
    padding: 0;
  }
  .medicine-entry {
    background: #fff;
    border: 1px solid #e0e0e0;
    border-radius: 6px;
    margin-bottom: 12px;
    padding: 16px 18px;
    display: flex;
    flex-direction: column;
    box-shadow: 0 2px 8px rgba(0,0,0,0.04);
  }
  .medicine-entry .medicine-title {
    font-weight: 500;
    color: #007bff;
    margin-bottom: 4px;
  }
  .medicine-entry .medicine-details {
    font-size: 15px;
    color: #444;
    margin-bottom: 8px;
  }
  .medicine-entry .view-in-store-btn {
    align-self: flex-start;
    margin-top: 4px;
    font-size: 14px;
    padding: 4px 12px;
    border-radius: 4px;
    background: #28a745;
    color: #fff;
    border: none;
    transition: background 0.2s;
    text-decoration: none;
  }
  .medicine-entry .view-in-store-btn:hover {
    background: #218838;
    color: #fff;
    text-decoration: none;
  }
  
  /* Test entry styling */
  .test-entry {
    background: #fff;
    border: 1px solid #e0e0e0;
    border-radius: 6px;
    margin-bottom: 12px;
    padding: 16px 18px;
    display: flex;
    flex-direction: column;
    box-shadow: 0 2px 8px rgba(0,0,0,0.04);
  }
  .test-entry .test-title {
    font-weight: 500;
    color: #17a2b8;
    margin-bottom: 4px;
  }
  .test-entry .test-details {
    font-size: 15px;
    color: #444;
    margin-bottom: 8px;
  }
  .test-entry .view-in-store-btn {
    align-self: flex-start;
    margin-top: 4px;
    font-size: 14px;
    padding: 4px 12px;
    border-radius: 4px;
    background: #17a2b8;
    color: #fff;
    border: none;
    transition: background 0.2s;
    text-decoration: none;
  }
  .test-entry .view-in-store-btn:hover {
    background: #138496;
    color: #fff;
    text-decoration: none;
  }
  /* Loading state for buttons */
  .btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }
  /* Add any additional CSS styles as needed */
  .take-leave-btn-container {
    position: absolute;
    top: 0;
    right: 0;
    z-index: 1100;
    margin: 20px 30px 0 0;
  }
  .doctor-status {
    position: absolute;
    top: 30px;
    left: 40px;
    z-index: 1100;
    font-size: 1.2rem;
    font-weight: bold;
  }
  .doctor-status-available { color: green; }
  .doctor-status-unavailable { color: red; }
  html, body {
    height: 100%;
  }
  body {
    min-height: 100vh;
    overflow-y: auto;
  }
  .card.mx-4.mx-md-5.shadow-5-strong {
    max-height: 90vh;
    overflow-y: auto;
  }
</style>

<!-- Remove doctor-status from dashboard -->

<div class="card mx-4 mx-md-5 shadow-5-strong" style="background: hsla(0, 0%, 100%, 0.8); backdrop-filter: blur(30px); position: relative;">
    <div class="card-body py-5 px-md-5">
        {% if is_doctor %}
        <!-- Leave Modal -->
        <div class="modal" id="leaveModal" tabindex="-1" style="display:none; background: rgba(0,0,0,0.3);">
          <div class="modal-dialog">
            <div class="modal-content">
              <form id="leaveForm" method="post" action="{% url 'doctor_take_leave' %}">
                {% csrf_token %}
                <div class="modal-header">
                  <h5 class="modal-title">Select Leave Dates</h5>
                  <button type="button" class="btn-close" onclick="closeLeaveModal()"></button>
                </div>
                <div class="modal-body">
                  <label for="leave-dates">Leave Period:</label>
                  <input type="text" id="leave-dates" name="leave_dates" class="form-control" placeholder="Select date range" required readonly>
                </div>
                <div class="modal-footer">
                  <button type="submit" class="btn btn-primary">Submit Leave</button>
                </div>
              </form>
            </div>
          </div>
        </div>
        {% endif %}
        {% if is_doctor %}
<div style="display: flex; align-items: center; justify-content: flex-end; gap: 32px; margin-bottom: 24px;">
  <button id="take-leave-btn" class="btn btn-warning take-leave-btn-custom" style="margin: 0;">
    TAKE LEAVE
  </button>
</div>
<style>
.switch {
  position: relative;
  display: inline-block;
  width: 50px;
  height: 24px;
}
.switch input {display:none;}
.slider {
  position: absolute;
  cursor: pointer;
  top: 0; left: 0; right: 0; bottom: 0;
  background-color: #ccc;
  transition: .4s;
  border-radius: 24px;
}
.slider:before {
  position: absolute;
  content: "";
  height: 18px; width: 18px;
  left: 3px; bottom: 3px;
  background-color: white;
  transition: .4s;
  border-radius: 50%;
}
input:checked + .slider {
  background-color: #28a745;
}
input:checked + .slider:before {
  transform: translateX(26px);
}
.take-leave-btn-custom {
  min-width: 120px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 600;
  font-size: 15px;
  border-radius: 6px;
}
</style>
{% endif %}
        <div class="row d-flex justify-content-center">
            <div class="col-lg-8">
                <h2 class="fw-bold mb-5 text-center">User Dashboard</h2>

                <!-- Upcoming Appointments -->
                <h3 class="mb-4 text-center">Upcoming Appointments</h3>
                {% if is_doctor %}
                  {% for appointment in upcoming_appointments %}
                    <div class="appointment">
                      <p>Date: {{ appointment.appointment_date }}</p>
                      <p>Time: {{ appointment.time }}</p>
                      <p>Patient: {{ appointment.user.get_full_name|default:appointment.user.username }}</p>
                      <p>Hospital: {{ appointment.hospital.name }}</p>
                      <p>Status: <span class="{% if appointment.status %}status-true{% else %}status-false{% endif %}">Upcoming</span></p>
                        <div class="d-flex align-items-center" style="gap: 10px;">
                          <a class="btn btn-info btn-sm ms-auto" href="{% url 'add_prescription' appointment.id %}">
                            {% if appointment.prescription %}Edit Prescription{% else %}Add Prescription{% endif %}
                          </a>
                        </div>
                      </div>
                    {% endfor %}
                  {% if upcoming_appointments|length == 0 %}
                    <p class="no-doctors-message">You don't have any upcoming appointments with patients.</p>
                  {% endif %}
                {% else %}
                  {% for appointment in upcoming_appointments %}
                    <div class="appointment">
                      <p>Date: {{ appointment.appointment_date }}</p>
                      <p>Time: {{ appointment.time }}</p>
                      <p>Doctor: {{ appointment.doctor.get_name }}</p>
                      <p>Hospital: {{ appointment.hospital.name }}</p>
                      <p>Status: <span class="{% if appointment.status %}status-true{% else %}status-false{% endif %}">Upcoming</span></p>
                      <div class="d-flex align-items-center" style="gap: 10px;">
                        <a href="{% url 'cancel_appointment' appointment.id %}" class="btn btn-danger btn-sm" style="color: #fff;">Cancel</a>
                        <a href="{% url 'reschedule_appointment' appointment.id %}" class="btn btn-warning btn-sm" style="color: #fff;">Reschedule</a>
                        <button class="btn btn-success btn-sm see-in-maps-btn ms-auto" data-hospital-location="{{ appointment.hospital.location }}" data-hospital-name="{{ appointment.hospital.name }}">See in Maps</button>
                        {% if appointment.prescription %}
                          <button class="btn btn-primary btn-sm view-prescription-btn ms-2" data-appointment-id="{{ appointment.id }}">View Prescription</button>
                        {% endif %}
                      </div>
                    </div>
                  {% endfor %}
                  {% if upcoming_appointments|length == 0 %}
                    <p class="no-doctors-message">You don't have any upcoming appointments</p>
                  {% endif %}
                {% endif %}
                <!-- Upcoming Video Appointments -->
                <h3 class="mb-4 text-center">Upcoming Video Appointments</h3>
                {% if upcoming_video_appointments %}
                  {% for vappt in upcoming_video_appointments %}
                    <div class="appointment" style="border-left: 4px solid #007bff;">
                      <p>Date: {{ vappt.start_time|date:"Y-m-d" }}</p>
                      <p>Start Time: {{ vappt.start_time|time:"H:i" }}</p>
                      <p>End Time: {{ vappt.end_time|time:"H:i" }}</p>
                      {% if is_doctor %}
                        <p>Patient: {{ vappt.patient.get_full_name|default:vappt.patient.username }}</p>
                        <div class="d-flex align-items-center" style="gap: 10px;">
                          <a class="btn btn-info btn-sm ms-auto" href="{% url 'add_video_prescription' vappt.id %}">
                            {% if vappt.prescription %}Edit Prescription{% else %}Add Prescription{% endif %}
                          </a>
                        </div>
                      {% else %}
                        <p>Doctor: {{ vappt.doctor.get_name }}</p>
                        <div class="d-flex align-items-center" style="gap: 10px;">
                          {% if vappt.prescription %}
                            <button class="btn btn-primary btn-sm view-video-prescription-btn ms-auto" data-video-appointment-id="{{ vappt.id }}">View Prescription</button>
                          {% endif %}
                        </div>
                      {% endif %}
                      <p>Status: <span class="{% if vappt.status == 'active' %}status-true{% elif vappt.status == 'pending' %}status-false{% else %}status-past{% endif %}">{{ vappt.get_status_display }}</span></p>
                    </div>
                  {% endfor %}
                {% else %}
                  <p class="no-doctors-message">You don't have any upcoming video appointments.</p>
                {% endif %}

                <!-- Past Appointments -->
                <h3 class="mb-4 text-center">Past Appointments</h3>
                {% if is_doctor %}
                  {% for appointment in past_appointments %}
                    <div class="appointment">
                      <p>Date: {{ appointment.appointment_date }}</p>
                      <p>Time: {{ appointment.time }}</p>
                      <p>Patient: {{ appointment.user.get_full_name|default:appointment.user.username }}</p>
                      <p>Hospital: {{ appointment.hospital.name }}</p>
                      <p>Status: <span class="status-past">Past</span></p>
                    </div>
                  {% endfor %}
                  {% if past_appointments|length == 0 %}
                    <p class="no-doctors-message">You haven't had any past appointments with patients.</p>
                  {% endif %}
                {% else %}
                  {% for appointment in past_appointments %}
                    <div class="appointment">
                      <p>Date: {{ appointment.appointment_date }}</p>
                      <p>Time: {{ appointment.time }}</p>
                      <p>Doctor: {{ appointment.doctor.get_name }}</p>
                      <p>Hospital: {{ appointment.hospital.name }}</p>
                      <p>Status: <span class="status-past">Past</span></p>
                      <div class="d-flex align-items-center" style="gap: 10px;">
                        {% if appointment.prescription %}
                          <button class="btn btn-primary btn-sm view-prescription-btn ms-auto" data-appointment-id="{{ appointment.id }}">View Prescription</button>
                        {% endif %}
                      </div>
                    </div>
                  {% endfor %}
                  {% if past_appointments|length == 0 %}
                    <p class="no-doctors-message">You haven't consulted our doctors before</p>
                  {% endif %}
                {% endif %}
                
                <!-- Past Video Appointments -->
                <h3 class="mb-4 text-center">Past Video Appointments</h3>
                {% if past_video_appointments %}
                  {% for vappt in past_video_appointments %}
                    <div class="appointment" style="border-left: 4px solid #bdbdbd;">
                      <p>Date: {{ vappt.start_time|date:"Y-m-d" }}</p>
                      <p>Start Time: {{ vappt.start_time|time:"H:i" }}</p>
                      <p>End Time: {{ vappt.end_time|time:"H:i" }}</p>
                      {% if is_doctor %}
                        <p>Patient: {{ vappt.patient.get_full_name|default:vappt.patient.username }}</p>
                        <div class="d-flex align-items-center" style="gap: 10px;">
                          <a class="btn btn-info btn-sm ms-auto" href="{% url 'add_video_prescription' vappt.id %}">
                            {% if vappt.prescription %}Edit Prescription{% else %}Add Prescription{% endif %}
                          </a>
                        </div>
                      {% else %}
                        <p>Doctor: {{ vappt.doctor.get_name }}</p>
                        <div class="d-flex align-items-center" style="gap: 10px;">
                          {% if vappt.prescription %}
                            <button class="btn btn-primary btn-sm view-video-prescription-btn ms-auto" data-video-appointment-id="{{ vappt.id }}">View Prescription</button>
                          {% endif %}
                        </div>
                      {% endif %}
                      <p>Status: <span class="status-past">{{ vappt.get_status_display }}</span></p>
                    </div>
                  {% endfor %}
                {% else %}
                  <p class="no-doctors-message">You don't have any past video appointments.</p>
                {% endif %}
                
                <!-- Medicine Orders (only for regular users) -->
                {% if not is_doctor and medicine_orders %}
                <h3 class="mb-4 text-center">Your Medicine Orders</h3>
                {% for order in medicine_orders %}
                <div class="appointment" style="border-left: 4px solid #28a745;">
                  <div class="row">
                    <div class="col-md-8">
                      <p><strong>Order #{{ order.id }}</strong> - {{ order.order_date|date:"F j, Y" }}</p>
                      <p><strong>Expected Delivery:</strong> {{ order.expected_delivery_date|date:"F j, Y" }}</p>
                      <p><strong>Delivery Address:</strong> {{ order.delivery_address }}</p>
                      <p><strong>Pincode:</strong> {{ order.delivery_pincode }}</p>
                      <p><strong>Total Amount:</strong> ₹{{ order.total_amount }}</p>
                      
                      <!-- Status Progress Bar -->
                      <div class="mt-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                          <span class="fw-bold">Order Status:</span>
                          <span class="badge {% if order.status == 'ordered' %}bg-primary{% elif order.status == 'processing' %}bg-warning{% elif order.status == 'shipped' %}bg-info{% else %}bg-success{% endif %}">
                            {{ order.get_status_display|title }}
                          </span>
                        </div>
                        <div class="progress" style="height: 8px;">
                          <div class="progress-bar bg-success" role="progressbar" style="width: {{ order.get_status_progress }}%" aria-valuenow="{{ order.get_status_progress }}" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                        <div class="d-flex justify-content-between mt-1">
                          <small class="text-muted">Ordered</small>
                          <small class="text-muted">Processing</small>
                          <small class="text-muted">Shipped</small>
                          <small class="text-muted">Delivered</small>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <h6 class="mb-2">Order Items:</h6>
                      {% for item in order.items.all %}
                      <div class="small mb-1">
                        <span class="fw-bold">{{ item.quantity }}x</span> {{ item.medicine.name }}
                        <br><span class="text-muted">₹{{ item.price_per_unit }} each</span>
                      </div>
                      {% endfor %}
                    </div>
                  </div>
                </div>
                {% endfor %}
                {% elif not is_doctor %}
                <h3 class="mb-4 text-center">Your Medicine Orders</h3>
                <p class="no-doctors-message">You haven't placed any medicine orders yet.</p>
                
                <!-- Lab Test Orders (Upcoming & Past) -->
                <h3 class="mb-4 text-center">Upcoming Lab Tests</h3>
                {% if upcoming_test_orders %}
                  {% for order in upcoming_test_orders %}
                  <div class="appointment" style="border-left: 4px solid #17a2b8;">
                    <div class="row">
                      <div class="col-md-8">
                        <p><strong>Test Order #{{ order.id }}</strong> - {{ order.order_date|date:"F j, Y" }}</p>
                        <p><strong>Test Date:</strong> {{ order.test_date|date:"F j, Y" }}</p>
                        <p><strong>Test Time:</strong> {{ order.test_time|time:"g:i A" }}</p>
                        <p><strong>Hospital:</strong> {{ order.hospital.name }}</p>
                        <p><strong>Total Amount:</strong> ₹{{ order.total_amount }}</p>
                        {% if order.notes %}
                          <p><strong>Notes:</strong> {{ order.notes }}</p>
                        {% endif %}
                        <!-- Status Progress Bar -->
                        <div class="mt-3">
                          <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="fw-bold">Test Status:</span>
                            <span class="badge {% if order.status == 'booked' %}bg-primary{% elif order.status == 'sample_collected' %}bg-warning{% elif order.status == 'processing' %}bg-info{% else %}bg-success{% endif %}">
                              {{ order.get_status_display|title }}
                            </span>
                          </div>
                          <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-info" role="progressbar" style="width: {{ order.get_status_progress }}%" aria-valuenow="{{ order.get_status_progress }}" aria-valuemin="0" aria-valuemax="100"></div>
                          </div>
                          <div class="d-flex justify-content-between mt-1">
                            <small class="text-muted">Booked</small>
                            <small class="text-muted">Sample Collected</small>
                            <small class="text-muted">Processing</small>
                            <small class="text-muted">Completed</small>
                          </div>
                        </div>
                      </div>
                      <div class="col-md-4">
                        <h6 class="mb-2">Test Items:</h6>
                        {% for item in order.items.all %}
                        <div class="small mb-1">
                          <span class="fw-bold">{{ item.test.test_type.name }}</span>
                          <br><span class="text-muted">₹{{ item.price }}</span>
                          {% if item.test.test_included %}
                            <br><small class="text-info">{{ item.test.test_included }}</small>
                          {% endif %}
                        </div>
                        {% endfor %}
                        <!-- Move View Report button to the bottom -->
                      </div>
                      {% if order.report %}
                        <div class="mt-3">
                          <a href="{% url 'view_test_report' order.id %}" class="btn btn-info btn-sm">View Report</a>
                        </div>
                      {% endif %}
                    </div>
                  </div>
                  {% endfor %}
                {% else %}
                  <p class="no-doctors-message">You have no upcoming lab tests.</p>
                {% endif %}

                <h3 class="mb-4 text-center">Past Lab Tests</h3>
                {% if past_test_orders %}
                  {% for order in past_test_orders %}
                  <div class="appointment" style="border-left: 4px solid #bdbdbd;">
                    <div class="row">
                      <div class="col-md-8">
                        <p><strong>Test Order #{{ order.id }}</strong> - {{ order.order_date|date:"F j, Y" }}</p>
                        <p><strong>Test Date:</strong> {{ order.test_date|date:"F j, Y" }}</p>
                        <p><strong>Test Time:</strong> {{ order.test_time|time:"g:i A" }}</p>
                        <p><strong>Hospital:</strong> {{ order.hospital.name }}</p>
                        <p><strong>Total Amount:</strong> ₹{{ order.total_amount }}</p>
                        {% if order.notes %}
                          <p><strong>Notes:</strong> {{ order.notes }}</p>
                        {% endif %}
                        <!-- Status Progress Bar -->
                        <div class="mt-3">
                          <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="fw-bold">Test Status:</span>
                            <span class="badge {% if order.status == 'booked' %}bg-primary{% elif order.status == 'sample_collected' %}bg-warning{% elif order.status == 'processing' %}bg-info{% else %}bg-success{% endif %}">
                              {{ order.get_status_display|title }}
                            </span>
                          </div>
                          <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-info" role="progressbar" style="width: {{ order.get_status_progress }}%" aria-valuenow="{{ order.get_status_progress }}" aria-valuemin="0" aria-valuemax="100"></div>
                          </div>
                          <div class="d-flex justify-content-between mt-1">
                            <small class="text-muted">Booked</small>
                            <small class="text-muted">Sample Collected</small>
                            <small class="text-muted">Processing</small>
                            <small class="text-muted">Completed</small>
                          </div>
                        </div>
                      </div>
                      <div class="col-md-4">
                        <h6 class="mb-2">Test Items:</h6>
                        {% for item in order.items.all %}
                        <div class="small mb-1">
                          <span class="fw-bold">{{ item.test.test_type.name }}</span>
                          <br><span class="text-muted">₹{{ item.price }}</span>
                          {% if item.test.test_included %}
                            <br><small class="text-info">{{ item.test.test_included }}</small>
                          {% endif %}
                        </div>
                        {% endfor %}
                        <!-- Move View Report button to the bottom -->
                      </div>
                      {% if order.report %}
                        <div class="mt-3">
                          <a href="{% url 'view_test_report' order.id %}" class="btn btn-info btn-sm">View Report</a>
                        </div>
                      {% endif %}
                    </div>
                  </div>
                  {% endfor %}
                {% else %}
                  <p class="no-doctors-message">You have no past lab tests.</p>
                {% endif %}
                
                <!-- Delivery Address Update -->
                <div class="mt-4">
                  <h4 class="mb-3 text-center">Update Delivery Address & Pincode</h4>
                  <form method="POST" action="{% url 'update_address' %}" class="row justify-content-center">
                    {% csrf_token %}
                    <div class="col-md-6">
                      <div class="mb-3">
                        <label class="form-label">Delivery Address:</label>
                        <input type="text" class="form-control" name="address" placeholder="Enter your delivery address" value="{{ user.profile.address }}" required>
                      </div>
                    </div>
                    <div class="col-md-3">
                      <div class="mb-3">
                        <label class="form-label">Pincode:</label>
                        <input type="text" class="form-control" name="pincode" placeholder="Enter pincode" value="{{ user.profile.pincode }}" required>
                      </div>
                    </div>
                    <div class="col-md-3">
                      <div class="mb-3">
                        <label class="form-label">&nbsp;</label>
                        <button type="submit" class="btn btn-primary w-100">Update</button>
                      </div>
                    </div>
                  </form>
                </div>
                {% endif %}
            </div>
        </div>
        <div class="text-center">
            {% if messages %}
                {% for message in messages %}
                    <div class="alert {% if 'success' in message.tags %}alert-success{% elif 'info' in message.tags %}alert-warning{% endif %}" role="alert">
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}
        </div>
    </div>
</div>

<div class="modal fade" id="mapModal" tabindex="-1" aria-labelledby="mapModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="mapModalLabel">Route to Hospital</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="route-map" style="height: 400px; width: 100%;"></div>
        <div id="route-details" style="margin-top: 10px;"></div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="prescriptionModal" tabindex="-1" aria-labelledby="prescriptionModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="prescriptionModalLabel">Prescription Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="prescription-modal-body">
        <div id="prescription-loading" style="display:none;">Loading...</div>
        <div id="prescription-content" style="display:none;">
          <h6>Doctor: <span id="prescription-doctor-name"></span></h6>
          <h6>Doctor's Notes:</h6>
          <p id="prescription-doctor-notes"></p>
          <h6>Diagnosis:</h6>
          <p id="prescription-diagnosis"></p>
          <h6>Medicines:</h6>
          <ul id="prescription-medicines-list"></ul>
          <h6>Prescribed Tests:</h6>
          <ul id="prescription-tests-list"></ul>
        </div>
        <div id="prescription-error" class="alert alert-danger" style="display:none;"></div>
        <div class="text-center mt-4">
            <a id="download-prescription-pdf" class="btn btn-outline-primary" style="display:none;" target="_blank">Download Prescription as PDF</a>
          </div>
      </div>
    </div>
  </div>
</div>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  var mapModalEl = document.getElementById('mapModal');
  var mapModal = new bootstrap.Modal(mapModalEl);
  var map, routingControl;
  var pendingRoute = null;

  document.querySelectorAll('.see-in-maps-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
          var userLat = position.coords.latitude;
          var userLng = position.coords.longitude;
          var hospitalLocation = btn.getAttribute('data-hospital-location');
          var hospitalName = btn.getAttribute('data-hospital-name');
          pendingRoute = {userLat, userLng, hospitalLocation, hospitalName};
          mapModal.show();
        }, function() {
          alert('Could not get your location.');
        });
      } else {
        alert('Geolocation is not supported by your browser.');
      }
    });
  });

  mapModalEl.addEventListener('shown.bs.modal', function () {
    if (pendingRoute) {
      setTimeout(function() {
        if (map) {
          map.remove();
          document.getElementById('route-map').innerHTML = '';
          document.getElementById('route-details').innerHTML = '';
        }
        var userLat = pendingRoute.userLat;
        var userLng = pendingRoute.userLng;
        var hospitalLocation = pendingRoute.hospitalLocation;
        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(hospitalLocation)}`)
          .then(response => response.json())
          .then(data => {
            if (data && data.length > 0) {
              var hospitalLat = parseFloat(data[0].lat);
              var hospitalLng = parseFloat(data[0].lon);
              map = L.map('route-map').setView([userLat, userLng], 13);
              L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
              }).addTo(map);
              routingControl = L.Routing.control({
                waypoints: [
                  L.latLng(userLat, userLng),
                  L.latLng(hospitalLat, hospitalLng)
                ],
                routeWhileDragging: false,
                show: true, 
                addWaypoints: false,
                draggableWaypoints: false,
                fitSelectedRoutes: true,
                showAlternatives: false
              }).addTo(map);
              routingControl.on('routesfound', function(e) {
                var routes = e.routes;
                var summary = routes[0].summary;
                document.getElementById('route-details').innerHTML =
                  `<b>Distance:</b> ${(summary.totalDistance / 1000).toFixed(2)} km<br>` +
                  `<b>Estimated Time:</b> ${(summary.totalTime / 60).toFixed(0)} min`;
              });
            } else {
              document.getElementById('route-details').innerHTML = 'Could not find hospital location.';
            }
          });
        pendingRoute = null;
      }, 200);
    }
  });

  mapModalEl.addEventListener('hidden.bs.modal', function () {
    if (map) {
      map.remove();
      document.getElementById('route-map').innerHTML = '';
      document.getElementById('route-details').innerHTML = '';
    }
  });

  var prescriptionModalEl = document.getElementById('prescriptionModal');
  var prescriptionModal = new bootstrap.Modal(prescriptionModalEl);
  document.querySelectorAll('.view-prescription-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
      var appointmentId = btn.getAttribute('data-appointment-id');
      var loading = document.getElementById('prescription-loading');
      var content = document.getElementById('prescription-content');
      var error = document.getElementById('prescription-error');
      loading.style.display = 'block';
      content.style.display = 'none';
      error.style.display = 'none';
      prescriptionModal.show();
      fetch(`/get-prescription-details/${appointmentId}/`)
        .then(response => response.json())
        .then(data => {
          loading.style.display = 'none';
          if (data.success) {
            document.getElementById('prescription-doctor-name').textContent = data.doctor_name;
            document.getElementById('prescription-doctor-notes').textContent = data.doctor_notes || '-';
            document.getElementById('prescription-diagnosis').textContent = data.diagnosis || '-';
            var medicinesList = document.getElementById('prescription-medicines-list');
            medicinesList.innerHTML = '';
            if (data.medicines.length > 0) {
              data.medicines.forEach(function(med) {
                var li = document.createElement('li');
                li.className = 'medicine-entry';
                li.innerHTML = `
                  <div class="medicine-title">${med.name}</div>
                  <div class="medicine-details">${med.dosage} ${med.dosage_unit}, ${med.frequency}, for ${med.num_days} days${med.food_relation ? ', ' + med.food_relation : ''}</div>
                  <a class="view-in-store-btn" href="/medicines/?highlight=${med.id}">View in Store</a>
                `;
                medicinesList.appendChild(li);
              });
            } else {
              var li = document.createElement('li');
              li.textContent = 'No medicines prescribed.';
              medicinesList.appendChild(li);
            }
            
            // Handle tests
            var testsList = document.getElementById('prescription-tests-list');
            testsList.innerHTML = '';
            if (data.tests && data.tests.length > 0) {
              data.tests.forEach(function(test) {
                var li = document.createElement('li');
                li.className = 'test-entry';
                var priorityClass = test.priority === 'urgent' ? 'text-warning' : test.priority === 'emergency' ? 'text-danger' : 'text-info';
                li.innerHTML = `
                  <div class="test-title">${test.name} <span class="badge ${priorityClass}">${test.priority}</span></div>
                  <div class="test-details">Sample: ${test.sample_required || 'Not specified'}${test.notes ? ', Notes: ' + test.notes : ''}</div>
                  <a class="view-in-store-btn" href="/tests/?highlight=${test.id}">View in Store</a>
                `;
                testsList.appendChild(li);
              });
            } else {
              var li = document.createElement('li');
              li.textContent = 'No tests prescribed.';
              testsList.appendChild(li);
            }
            content.style.display = 'block';
            // Show download PDF button
            const downloadBtn = document.getElementById('download-prescription-pdf');
            downloadBtn.style.display = 'inline-block';
            downloadBtn.href = `/prescription-pdf/${appointmentId}/`;
          } else {
            error.textContent = data.error || 'No prescription found.';
            error.style.display = 'block';
            document.getElementById('download-prescription-pdf').style.display = 'none';
          }
        })
        .catch(err => {
          loading.style.display = 'none';
          error.textContent = 'Failed to fetch prescription details.';
          error.style.display = 'block';
        });
    });
  });

  // Handler for video appointment prescription view
  document.querySelectorAll('.view-video-prescription-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
      var videoAppointmentId = btn.getAttribute('data-video-appointment-id');
      var loading = document.getElementById('prescription-loading');
      var content = document.getElementById('prescription-content');
      var error = document.getElementById('prescription-error');
      loading.style.display = 'block';
      content.style.display = 'none';
      error.style.display = 'none';
      prescriptionModal.show();
      fetch(`/get-video-prescription-details/${videoAppointmentId}/`)
        .then(response => response.json())
        .then(data => {
          loading.style.display = 'none';
          if (data.success) {
            document.getElementById('prescription-doctor-name').textContent = '';
            document.getElementById('prescription-doctor-notes').textContent = '';
            document.getElementById('prescription-diagnosis').textContent = data.diagnosis || '-';
            var medicinesList = document.getElementById('prescription-medicines-list');
            medicinesList.innerHTML = '';
            if (data.medicines.length > 0) {
              data.medicines.forEach(function(med) {
                var li = document.createElement('li');
                li.className = 'medicine-entry';
                li.innerHTML = `
                  <div class="medicine-title">${med.name}</div>
                  <div class="medicine-details">${med.dosage} ${med.dosage_unit}, ${med.frequency}, for ${med.num_days} days${med.food_relation ? ', ' + med.food_relation : ''}</div>
                  <a class="view-in-store-btn" href="/medicines/?highlight=${med.id}">View in Store</a>
                `;
                medicinesList.appendChild(li);
              });
            } else {
              var li = document.createElement('li');
              li.textContent = 'No medicines prescribed.';
              medicinesList.appendChild(li);
            }
            var testsList = document.getElementById('prescription-tests-list');
            testsList.innerHTML = '';
            if (data.tests && data.tests.length > 0) {
              data.tests.forEach(function(test) {
                var li = document.createElement('li');
                li.className = 'test-entry';
                var priorityClass = test.priority === 'urgent' ? 'text-warning' : test.priority === 'emergency' ? 'text-danger' : 'text-info';
                li.innerHTML = `
                  <div class="test-title">${test.name} <span class="badge ${priorityClass}">${test.priority}</span></div>
                  <div class="test-details">Sample: ${test.sample_required || 'Not specified'}${test.notes ? ', Notes: ' + test.notes : ''}</div>
                  <a class="view-in-store-btn" href="/tests/?highlight=${test.id}">View in Store</a>
                `;
                testsList.appendChild(li);
              });
            } else {
              var li = document.createElement('li');
              li.textContent = 'No tests prescribed.';
              testsList.appendChild(li);
            }
            content.style.display = 'block';
            // Show download PDF button for video appointment
            const downloadBtn = document.getElementById('download-prescription-pdf');
            downloadBtn.style.display = 'inline-block';
            downloadBtn.href = `/video-prescription-pdf/${videoAppointmentId}/`;
          } else {
            error.textContent = data.error || 'No prescription found.';
            error.style.display = 'block';
            document.getElementById('download-prescription-pdf').style.display = 'none';
          }
        })
        .catch(err => {
          loading.style.display = 'none';
          error.textContent = 'Failed to fetch prescription details.';
          error.style.display = 'block';
        });
    });
  });
});
</script>

{% if is_doctor %}
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script>
function openLeaveModal() {
  document.getElementById('leaveModal').style.display = 'block';
}
function closeLeaveModal() {
  document.getElementById('leaveModal').style.display = 'none';
}
document.addEventListener('DOMContentLoaded', function() {
  const btn = document.getElementById('take-leave-btn');
  if (btn) {
    btn.addEventListener('click', openLeaveModal);
  }
  flatpickr('#leave-dates', {
    mode: 'range',
    minDate: 'today',
    dateFormat: 'Y-m-d',
    allowInput: false
  });
});
</script>
{% endif %}

{% endblock %}
