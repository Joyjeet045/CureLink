{% extends "base.html" %}

{% block content %}
<style>
  .appointment {
    background-color: #f5f5f5;
    border: 1px solid #ccc;
    margin-bottom: 10px;
    padding: 10px;
    border-radius: 5px;
  }

  .appointment a {
    text-decoration: none;
    color: #007BFF;
    margin-left: 10px;
  }

  .alert {
    margin-top: 20px;
  }

  /* Green color for True and Red for False */
  .status-true {
    color: green;
  }

  .status-false {
    color: red;
  }
  .no-doctors-message {
    font-size: 18px;
    color: #FF0000; 
    text-align: center;
    margin-top: 20px;
    font-weight: bold;
  }
  .modal {
  z-index: 1050 !important;
  }

  .modal-backdrop {
    z-index: 1040 !important;
  }

  /* Fix modal content scrolling */
  .modal-dialog {
    max-height: 90vh;
    overflow-y: auto;
  }

  /* Ensure form elements are properly styled and not disabled */
  .modal .form-control,
  .modal .form-select {
    background-color: #fff !important;
    border: 1px solid #ced4da !important;
    opacity: 1 !important;
    pointer-events: auto !important;
  }

  /* Fix button states */
  .modal .btn {
    pointer-events: auto !important;
    opacity: 1 !important;
  }

  /* Ensure modal body content is scrollable */
  .modal-body {
    max-height: 70vh;
    overflow-y: auto;
  }

  /* Fix prescription form specific styling */
  #prescription-modal-body {
    min-height: 200px;
  }

  /* Loading state for buttons */
  .btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }
  /* Add any additional CSS styles as needed */
</style>

<div class="card mx-4 mx-md-5 shadow-5-strong" style="background: hsla(0, 0%, 100%, 0.8); backdrop-filter: blur(30px);">
    <div class="card-body py-5 px-md-5">
        <div class="row d-flex justify-content-center">
            <div class="col-lg-8">
                <h2 class="fw-bold mb-5 text-center">User Dashboard</h2>

                <!-- Upcoming Appointments -->
                <h3 class="mb-4 text-center">Upcoming Appointments</h3>
                {% if is_doctor %}
                  {% for appointment in upcoming_appointments %}
                    <div class="appointment">
                      <p>Date: {{ appointment.appointment_date }}</p>
                      <p>Time: {{ appointment.time }}</p>
                      <p>Patient: {{ appointment.user.get_full_name|default:appointment.user.username }}</p>
                      <p>Hospital: {{ appointment.hospital.name }}</p>
                      <p>Status: <span class="{% if appointment.status %}status-true{% else %}status-false{% endif %}">Upcoming</span></p>
                        <div class="d-flex align-items-center" style="gap: 10px;">
                          <a class="btn btn-info btn-sm ms-auto" href="/appointment/{{ appointment.id }}/prescription/">
                            {% if appointment.prescription %}Edit Prescription{% else %}Add Prescription{% endif %}
                          </a>
                        </div>
                      </div>
                    {% endfor %}
                  {% if upcoming_appointments|length == 0 %}
                    <p class="no-doctors-message">You don't have any upcoming appointments with patients.</p>
                  {% endif %}
                {% else %}
                  {% for appointment in upcoming_appointments %}
                    <div class="appointment">
                      <p>Date: {{ appointment.appointment_date }}</p>
                      <p>Time: {{ appointment.time }}</p>
                      <p>Doctor: {{ appointment.doctor.get_name }}</p>
                      <p>Hospital: {{ appointment.hospital.name }}</p>
                      <p>Status: <span class="{% if appointment.status %}status-true{% else %}status-false{% endif %}">Upcoming</span></p>
                      <div class="d-flex align-items-center" style="gap: 10px;">
                        <a href="{% url 'cancel_appointment' appointment.id %}" class="btn btn-danger btn-sm" style="color: #fff;">Cancel</a>
                        <a href="{% url 'reschedule_appointment' appointment.id %}" class="btn btn-warning btn-sm" style="color: #fff;">Reschedule</a>
                        <button class="btn btn-success btn-sm see-in-maps-btn ms-auto" data-hospital-location="{{ appointment.hospital.location }}" data-hospital-name="{{ appointment.hospital.name }}">See in Maps</button>
                      </div>
                    </div>
                  {% endfor %}
                  {% if upcoming_appointments|length == 0 %}
                    <p class="no-doctors-message">You don't have any upcoming appointments</p>
                  {% endif %}
                {% endif %}
                <!-- Past Appointments -->
                <h3 class="mb-4 text-center">Past Appointments</h3>
                {% if is_doctor %}
                  {% for appointment in past_appointments %}
                    <div class="appointment">
                      <p>Date: {{ appointment.appointment_date }}</p>
                      <p>Time: {{ appointment.time }}</p>
                      <p>Patient: {{ appointment.user.get_full_name|default:appointment.user.username }}</p>
                      <p>Hospital: {{ appointment.hospital.name }}</p>
                      <p>Status: <span class="{% if appointment.status %}status-true{% else %}status-false{% endif %}">Past</span></p>
                    </div>
                  {% endfor %}
                  {% if past_appointments|length == 0 %}
                    <p class="no-doctors-message">You haven't had any past appointments with patients.</p>
                  {% endif %}
                {% else %}
                  {% for appointment in past_appointments %}
                    <div class="appointment">
                      <p>Date: {{ appointment.appointment_date }}</p>
                      <p>Time: {{ appointment.time }}</p>
                      <p>Doctor: {{ appointment.doctor.get_name }}</p>
                      <p>Hospital: {{ appointment.hospital.name }}</p>
                      <p>Status: <span class="{% if appointment.status %}status-true{% else %}status-false{% endif %}">Past</span></p>
                    </div>
                  {% endfor %}
                  {% if past_appointments|length == 0 %}
                    <p class="no-doctors-message">You haven't consulted our doctors before</p>
                  {% endif %}
                {% endif %}
            </div>
        </div>
        <div class="text-center">
            {% if messages %}
                {% for message in messages %}
                    <div class="alert {% if 'success' in message.tags %}alert-success{% elif 'info' in message.tags %}alert-warning{% endif %}" role="alert">
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}
        </div>
    </div>
</div>

<div class="modal fade" id="mapModal" tabindex="-1" aria-labelledby="mapModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="mapModalLabel">Route to Hospital</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="route-map" style="height: 400px; width: 100%;"></div>
        <div id="route-details" style="margin-top: 10px;"></div>
      </div>
    </div>
  </div>
</div>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  var mapModalEl = document.getElementById('mapModal');
  var mapModal = new bootstrap.Modal(mapModalEl);
  var map, routingControl;
  var pendingRoute = null;

  document.querySelectorAll('.see-in-maps-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
          var userLat = position.coords.latitude;
          var userLng = position.coords.longitude;
          var hospitalLocation = btn.getAttribute('data-hospital-location');
          var hospitalName = btn.getAttribute('data-hospital-name');
          pendingRoute = {userLat, userLng, hospitalLocation, hospitalName};
          mapModal.show();
        }, function() {
          alert('Could not get your location.');
        });
      } else {
        alert('Geolocation is not supported by your browser.');
      }
    });
  });

  mapModalEl.addEventListener('shown.bs.modal', function () {
    if (pendingRoute) {
      setTimeout(function() {
        if (map) {
          map.remove();
          document.getElementById('route-map').innerHTML = '';
          document.getElementById('route-details').innerHTML = '';
        }
        var userLat = pendingRoute.userLat;
        var userLng = pendingRoute.userLng;
        var hospitalLocation = pendingRoute.hospitalLocation;
        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(hospitalLocation)}`)
          .then(response => response.json())
          .then(data => {
            if (data && data.length > 0) {
              var hospitalLat = parseFloat(data[0].lat);
              var hospitalLng = parseFloat(data[0].lon);
              map = L.map('route-map').setView([userLat, userLng], 13);
              L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
              }).addTo(map);
              routingControl = L.Routing.control({
                waypoints: [
                  L.latLng(userLat, userLng),
                  L.latLng(hospitalLat, hospitalLng)
                ],
                routeWhileDragging: false,
                show: true, 
                addWaypoints: false,
                draggableWaypoints: false,
                fitSelectedRoutes: true,
                showAlternatives: false
              }).addTo(map);
              routingControl.on('routesfound', function(e) {
                var routes = e.routes;
                var summary = routes[0].summary;
                document.getElementById('route-details').innerHTML =
                  `<b>Distance:</b> ${(summary.totalDistance / 1000).toFixed(2)} km<br>` +
                  `<b>Estimated Time:</b> ${(summary.totalTime / 60).toFixed(0)} min`;
              });
            } else {
              document.getElementById('route-details').innerHTML = 'Could not find hospital location.';
            }
          });
        pendingRoute = null;
      }, 200);
    }
  });

  mapModalEl.addEventListener('hidden.bs.modal', function () {
    if (map) {
      map.remove();
      document.getElementById('route-map').innerHTML = '';
      document.getElementById('route-details').innerHTML = '';
    }
  });
});
</script>

{% endblock %}
