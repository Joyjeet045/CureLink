{% extends "base.html" %}
{% load static %}
{% block content %}
  <div class="container mt-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2 class="mb-0">{{ hospital.name }}</h2>
      <a href="{% url 'add_test_for_hospital' %}" class="btn btn-success">+ Add New Test</a>
    </div>
    <h4 class="mb-4">Tests at this Hospital:</h4>
    <div class="row g-4">
      {% for test in tests %}
        <div class="col-12 col-md-6 col-lg-4 d-flex">
          <div class="card flex-fill shadow-sm position-relative">
            {% if test.test_included %}
              <span class="position-absolute top-0 end-0 badge rounded-pill bg-primary m-2" style="font-size:0.9em;">{{ test.included_list|length }}</span>
            {% endif %}
            <div class="card-body">
              <h5 class="card-title mb-2">{{ test.test_type.name }}</h5>
              <p class="card-text mb-1"><strong>Price:</strong> ₹{{ test.price }}</p>
              {% if test.test_included %}
                <p class="card-text mb-1"><strong>Includes:</strong> {{ test.test_included }}</p>
              {% endif %}
              {% if test.pre_test_instructions %}
                <p class="card-text mb-1"><strong>Instructions:</strong> {{ test.pre_test_instructions }}</p>
              {% endif %}
              <span class="badge bg-info text-dark">{{ test.get_sample_required_display }}</span>
            </div>
          </div>
        </div>
      {% empty %}
        <div class="col-12 text-center text-muted">No tests available.</div>
      {% endfor %}
    </div>
    <h4 class="mb-4">Pending Doctor Requests</h4>
    {% if pending_requests %}
      <div class="list-group mb-5">
        {% for req in pending_requests %}
          <div class="list-group-item d-flex justify-content-between align-items-center">
            <div>
              <strong>Doctor:</strong> {{ req.doctor.get_name }}<br>
              <strong>Requested At:</strong> {{ req.requested_at|date:"F j, Y, g:i a" }}
            </div>
            <form method="post" action="{% url 'approve_doctor_request' req.id %}">
              {% csrf_token %}
              <button type="submit" class="btn btn-success btn-sm">Approve</button>
            </form>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="mb-5 text-muted text-center">No pending doctor requests for this hospital.</div>
    {% endif %}
    {% if booked_orders %}
      <div class="mt-5">
        <h4 class="mb-4">Booked Test Orders</h4>
        <div class="row g-4">
          {% for order in booked_orders %}
            <div class="col-12 col-md-6 col-lg-4 d-flex">
              <div class="card flex-fill shadow-sm border-primary position-relative">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                  <span><i class="bi bi-person-circle me-2"></i>{{ order.user.get_full_name|default:order.user.username }}</span>
                  <span class="badge bg-info text-dark">Order #{{ order.id }}</span>
                </div>
                <div class="card-body">
                  <p class="mb-1"><i class="bi bi-calendar-event me-1"></i><strong>Date:</strong> {{ order.test_date }} <i class="bi bi-clock ms-2 me-1"></i><strong>Time:</strong> {{ order.test_time }}</p>
                  <p class="mb-2"><i class="bi bi-clipboard-check me-1"></i><strong>Status:</strong> <span class="badge bg-warning text-dark">{{ order.get_status_display }}</span></p>
                  <strong>Tests in this order:</strong>
                  <ul class="mb-2 ps-3">
                    {% for item in order.items.all %}
                      <li><i class="bi bi-droplet-half me-1"></i>{{ item.test.test_type.name }} <span class="text-muted">(₹{{ item.price }})</span></li>
                    {% endfor %}
                  </ul>
                  <div class="d-flex justify-content-between align-items-center mt-3">
                    <span class="fw-bold">Total: ₹{{ order.total_amount }}</span>
                    {% if order.payment_status %}
                      <span class="badge bg-success">Paid</span>
                    {% else %}
                      <span class="badge bg-danger">Unpaid</span>
                    {% endif %}
                  </div>
                  {% if order.notes %}
                    <div class="mt-2"><i class="bi bi-info-circle me-1"></i><strong>Notes:</strong> {{ order.notes }}</div>
                  {% endif %}
                  <div class="mt-3">
                    {% if not order.report %}
                      <a href="{% url 'create_test_report' order.id %}" class="btn btn-outline-primary btn-sm">Create Report</a>
                    {% else %}
                      <button class="btn btn-success btn-sm" disabled>Report Sent</button>
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
    {% else %}
      <div class="mt-5 text-muted text-center">No booked test orders for this hospital.</div>
    {% endif %}
    {% if messages %}
      <div class="mt-4">
        {% for message in messages %}
          <div class="alert alert-success" role="alert">{{ message }}</div>
        {% endfor %}
      </div>
    {% endif %}
  </div>
{% endblock %} 