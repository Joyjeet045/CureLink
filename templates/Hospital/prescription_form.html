{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
  <h2>Prescription for Appointment #{{ appointment.id }}</h2>
  <form id="prescription-form">
    <div id="medicines-container">
      <div class="medicine-entry row g-2 mb-2 align-items-end flex-nowrap">
        <div class="col-auto" style="min-width:180px;">
          <label class="form-label">Medicine *</label>
          <select class="form-select" name="medicine" required>
            <option value="">Select Medicine</option>
            {% for med in medicines %}
              <option value="{{ med.id }}">{{ med.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-auto" style="min-width:120px;">
          <label class="form-label">Dosage *</label>
          <input type="number" class="form-control" name="dosage" required>
        </div>
        <div class="col-auto" style="min-width:120px;">
          <label class="form-label">Unit</label>
          <select class="form-select" name="dosage_unit">
            <option value="Tablet(s)">Tablet(s)</option>
            <option value="Capsule(s)">Capsule(s)</option>
            <option value="ml">ml</option>
          </select>
        </div>
        <div class="col-auto" style="min-width:120px;">
          <label class="form-label">No. of Days *</label>
          <input type="number" class="form-control" name="num_days" required>
        </div>
        <div class="col-auto" style="min-width:140px;">
          <label class="form-label">Frequency *</label>
          <select class="form-select" name="frequency" required>
            <option value="1 time a day">1 time a day</option>
            <option value="2 times a day">2 times a day</option>
            <option value="3 times a day">3 times a day</option>
          </select>
        </div>
        <div class="col-auto" style="min-width:140px;">
          <label class="form-label">Food Relation</label>
          <select class="form-select" name="food_relation">
            <option value="">--</option>
            <option value="Before food">Before food</option>
            <option value="After food">After food</option>
          </select>
        </div>
        <div class="col-auto d-flex align-items-end">
          <button type="button" class="btn btn-danger btn-remove-medicine" style="display:none;">&minus;</button>
        </div>
      </div>
    </div>
    <div class="mb-2">
      <button type="button" class="btn btn-success" id="add-medicine-btn">+ Add Medicine</button>
    </div>
    <div class="mb-3">
      <label for="diagnosis" class="form-label">Diagnosis / Doctor's Notes</label>
      <textarea class="form-control" id="diagnosis" name="diagnosis" rows="2"></textarea>
    </div>
    
    <!-- Tests Section -->
    <div class="mb-3">
      <h5>Prescribed Tests</h5>
      <div id="tests-container">
        <div class="test-entry row g-2 mb-2 align-items-end flex-nowrap">
          <div class="col-auto" style="min-width:200px;">
            <label class="form-label">Test Type *</label>
            <select class="form-select" name="test_type" required>
              <option value="">Select Test Type</option>
              {% for test_type in test_types %}
                <option value="{{ test_type.id }}">{{ test_type.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-auto" style="min-width:120px;">
            <label class="form-label">Priority</label>
            <select class="form-select" name="priority">
              <option value="routine">Routine</option>
              <option value="urgent">Urgent</option>
              <option value="emergency">Emergency</option>
            </select>
          </div>
          <div class="col-auto" style="min-width:200px;">
            <label class="form-label">Notes</label>
            <input type="text" class="form-control" name="test_notes" placeholder="Additional notes">
          </div>
          <div class="col-auto d-flex align-items-end">
            <button type="button" class="btn btn-danger btn-remove-test" style="display:none;">&minus;</button>
          </div>
        </div>
      </div>
      <div class="mb-2">
        <button type="button" class="btn btn-info" id="add-test-btn">+ Add Test</button>
      </div>
    </div>
    
    <div class="d-flex justify-content-end">
      <button type="submit" class="btn btn-primary" id="send-prescription-btn">Save Prescription</button>
    </div>
  </form>
</div>
<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function getMedicineEntryHtml() {
  return `<div class=\"medicine-entry row g-2 mb-2 align-items-end flex-nowrap\">`
    + `<div class=\"col-auto\" style=\"min-width:180px;\">`
    + `<select class=\"form-select\" name=\"medicine\" required>`
    + `<option value=\"\">Select Medicine</option>`
    + `{% for med in medicines %}<option value=\"{{ med.id }}\">{{ med.name }}</option>{% endfor %}`
    + `</select></div>`
    + `<div class=\"col-auto\" style=\"min-width:120px;\"><input type=\"number\" class=\"form-control\" name=\"dosage\" required placeholder=\"Dosage\"></div>`
    + `<div class=\"col-auto\" style=\"min-width:120px;\"><select class=\"form-select\" name=\"dosage_unit\"><option value=\"Tablet(s)\">Tablet(s)</option><option value=\"Capsule(s)\">Capsule(s)</option><option value=\"ml\">ml</option></select></div>`
    + `<div class=\"col-auto\" style=\"min-width:120px;\"><input type=\"number\" class=\"form-control\" name=\"num_days\" required placeholder=\"No. of Days\"></div>`
    + `<div class=\"col-auto\" style=\"min-width:140px;\"><select class=\"form-select\" name=\"frequency\" required><option value=\"1 time a day\">1 time a day</option><option value=\"2 times a day\">2 times a day</option><option value=\"3 times a day\">3 times a day</option></select></div>`
    + `<div class=\"col-auto\" style=\"min-width:140px;\"><select class=\"form-select\" name=\"food_relation\"><option value=\"\">--</option><option value=\"Before food\">Before food</option><option value=\"After food\">After food</option></select></div>`
    + `<div class=\"col-auto d-flex align-items-end\"><button type=\"button\" class=\"btn btn-danger btn-remove-medicine\">&minus;</button></div>`
    + `</div>`;
}

function getTestEntryHtml() {
  return `<div class=\"test-entry row g-2 mb-2 align-items-end flex-nowrap\">`
    + `<div class=\"col-auto\" style=\"min-width:200px;\">`
    + `<select class=\"form-select\" name=\"test_type\" required>`
    + `<option value=\"\">Select Test Type</option>`
    + `{% for test_type in test_types %}<option value=\"{{ test_type.id }}\">{{ test_type.name }}</option>{% endfor %}`
    + `</select></div>`
    + `<div class=\"col-auto\" style=\"min-width:120px;\">`
    + `<select class=\"form-select\" name=\"priority\">`
    + `<option value=\"routine\">Routine</option>`
    + `<option value=\"urgent\">Urgent</option>`
    + `<option value=\"emergency\">Emergency</option>`
    + `</select></div>`
    + `<div class=\"col-auto\" style=\"min-width:200px;\">`
    + `<input type=\"text\" class=\"form-control\" name=\"test_notes\" placeholder=\"Additional notes\"></div>`
    + `<div class=\"col-auto d-flex align-items-end\">`
    + `<button type=\"button\" class=\"btn btn-danger btn-remove-test\">&minus;</button></div>`
    + `</div>`;
}

document.getElementById('add-medicine-btn').onclick = function() {
  var container = document.getElementById('medicines-container');
  var newEntry = document.createElement('div');
  newEntry.innerHTML = getMedicineEntryHtml();
  container.appendChild(newEntry.firstChild);
  updateRemoveButtons();
};

document.getElementById('add-test-btn').onclick = function() {
  var container = document.getElementById('tests-container');
  var newEntry = document.createElement('div');
  newEntry.innerHTML = getTestEntryHtml();
  container.appendChild(newEntry.firstChild);
  updateRemoveTestButtons();
};

function updateRemoveButtons() {
  var entries = document.querySelectorAll('.medicine-entry');
  entries.forEach(function(entry, idx) {
    var btn = entry.querySelector('.btn-remove-medicine');
    if (btn) {
      btn.style.display = (entries.length > 1) ? '' : 'none';
      btn.onclick = function() {
        entry.remove();
        updateRemoveButtons();
      };
    }
  });
}

function updateRemoveTestButtons() {
  var entries = document.querySelectorAll('.test-entry');
  entries.forEach(function(entry, idx) {
    var btn = entry.querySelector('.btn-remove-test');
    if (btn) {
      btn.style.display = (entries.length > 1) ? '' : 'none';
      btn.onclick = function() {
        entry.remove();
        updateRemoveTestButtons();
      };
    }
  });
}

updateRemoveButtons();
updateRemoveTestButtons();

document.getElementById('prescription-form').onsubmit = function(e) {
  e.preventDefault();
  var form = this;
  var formData = new FormData();
  var entries = document.querySelectorAll('.medicine-entry');
  entries.forEach(function(entry, idx) {
    formData.append('medicine', entry.querySelector('[name="medicine"]').value);
    formData.append('dosage', entry.querySelector('[name="dosage"]').value);
    formData.append('dosage_unit', entry.querySelector('[name="dosage_unit"]').value);
    formData.append('num_days', entry.querySelector('[name="num_days"]').value);
    formData.append('frequency', entry.querySelector('[name="frequency"]').value);
    formData.append('food_relation', entry.querySelector('[name="food_relation"]').value);
  });
  
  // Add test data
  var testEntries = document.querySelectorAll('.test-entry');
  testEntries.forEach(function(entry, idx) {
    formData.append('test_type', entry.querySelector('[name="test_type"]').value);
    formData.append('priority', entry.querySelector('[name="priority"]').value);
    formData.append('test_notes', entry.querySelector('[name="test_notes"]').value);
  });
  
  formData.append('diagnosis', document.getElementById('diagnosis').value);
  fetch(window.location.href, {
    method: 'POST',
    body: formData,
    headers: {
      'X-Requested-With': 'XMLHttpRequest',
      'X-CSRFToken': getCookie('csrftoken')
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      alert(data.message);
      window.location.href = '/dashboard/me/';
    } else {
      alert('Failed to send prescription.');
    }
  });
};
</script>
{% endblock %} 