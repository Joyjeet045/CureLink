{% extends "base.html" %}
{% block content %}
<style>
  .spread-container {
    max-width: 100vw;
    width: 100%;
    margin-left: auto;
    margin-right: auto;
    padding-left: 12px;
    padding-right: 12px;
  }
  .spread-table th, .spread-table td {
    white-space: normal;
    padding-left: 20px;
    padding-right: 20px;
    vertical-align: middle;
  }
  .filter-select {
    min-width: 180px;
    max-width: 260px;
    display: inline-block;
    margin-bottom: 24px;
    margin-right: 10px;
    border-radius: 8px;
    border: 1px solid #ced4da;
    padding: 6px 12px 6px 36px;
    background: #fff url('https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/icons/funnel.svg') no-repeat 8px center/18px 18px;
    font-size: 1rem;
    appearance: none;
    background-position: 8px center;
    background-repeat: no-repeat;
    background-size: 18px 18px;
  }
  @media (max-width: 1200px) {
    .spread-container { width: 100vw; max-width: 100vw; padding-left: 4px; padding-right: 4px; }
    .spread-table th, .spread-table td { padding-left: 6px; padding-right: 6px; }
  }
  
  /* Enhanced highlighting styles */
  .medicine-highlight {
    background: #fff9c4 !important;
    border: 2px solid #ffe082 !important;
    box-shadow: 0 0 10px 2px #fffde7 !important;
    color: #333 !important;
    transition: all 0.5s ease !important;
  }
  
  /* Ensure the entire row gets highlighted */
  .row-highlight {
    background: #fff9c4 !important;
    border: 2px solid #ffe082 !important;
    box-shadow: 0 0 10px 2px #fffde7 !important;
    transition: all 0.5s ease !important;
  }
  
  /* Override any Bootstrap table styles */
  .table > tbody > tr.row-highlight > td {
    background: #fff9c4 !important;
    border-color: #ffe082 !important;
  }
</style>

<div class="container mt-5 spread-container">
  <div class="row justify-content-center">
    <div class="col-12">
      <div class="card shadow-5-strong" style="background: hsla(0, 0%, 100%, 0.9); backdrop-filter: blur(20px);">
        <div class="card-body py-5 px-md-5">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h2 class="fw-bold mb-4 text-center text-primary">Medicines</h2>
            <a href="{% url 'medicine_cart_checkout' %}" class="btn btn-outline-secondary position-relative">
              <i class="fas fa-shopping-cart"></i>
              <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                {% if request.session.medicine_cart %}
                  {{ request.session.medicine_cart|length }}
                {% else %}
                  0
                {% endif %}
              </span>
            </a>
          </div>
          <p class="text-center text-muted">Browse and order medicines here.</p>
          <form method="get" class="d-flex justify-content-end align-items-center mb-3" style="gap: 10px;">
            <label for="cure_to" class="me-2 mb-0"><i class="fas fa-filter"></i> <span class="d-none d-md-inline">Filter by Cure To:</span></label>
            <select name="cure_to" id="cure_to" class="filter-select" onchange="this.form.submit()">
              <option value="">All</option>
              {% for value, label in cure_choices %}
                <option value="{{ value }}" {% if selected_cure == value %}selected{% endif %}>{{ label }}</option>
              {% endfor %}
            </select>
          </form>
          {% if medicines %}
          <div class="table-responsive">
            <table class="table table-bordered table-hover align-middle spread-table">
              <thead class="table-light">
                <tr>
                  <th>Name</th>
                  <th>Description</th>
                  <th>Cure To</th>
                  <th>Price</th>
                  <th>Stock</th>
                  <th>Requires Prescription</th>
                  <th>Seller</th>
                  <th>Picture</th>
                  <th>Quantity</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody>
                {% for medicine in medicines %}
                <tr id="medicine-{{ medicine.id }}">
                  <td>{{ medicine.name }}</td>
                  <td>{{ medicine.description }}</td>
                  <td>{{ medicine.cure_to }}</td>
                  <td>â‚¹{{ medicine.price }}</td>
                  <td>{{ medicine.stock }}</td>
                  <td>{% if medicine.requires_prescription %}Yes{% else %}No{% endif %}</td>
                  <td>{{ medicine.seller.username }}</td>
                  <td>
                    {% if medicine.picture %}
                      <img src="{{ medicine.picture.url }}" alt="{{ medicine.name }}" style="max-width: 60px; max-height: 60px;">
                    {% else %}
                      <span class="text-muted">No Image</span>
                    {% endif %}
                  </td>
                  <td>
                    <div class="input-group" style="width: 120px;">
                      <button class="btn btn-outline-secondary btn-sm" type="button" onclick="decreaseQuantity({{ medicine.id }})">-</button>
                      <input type="number" class="form-control form-control-sm text-center" id="quantity-{{ medicine.id }}" value="1" max="{{ medicine.stock }}" style="width: 50px;">
                      <button class="btn btn-outline-secondary btn-sm" type="button" onclick="increaseQuantity({{ medicine.id }}, {{ medicine.stock }})">+</button>
                    </div>
                  </td>
                  <td>
                    <form method="post" action="{% url 'add_medicine_to_cart' medicine.id %}" style="display: inline;">
                      {% csrf_token %}
                      <input type="hidden" name="quantity" id="hidden-quantity-{{ medicine.id }}" value="1">
                      <button type="submit" class="btn btn-success btn-sm" onclick="updateHiddenQuantity({{ medicine.id }})">
                        <i class="fas fa-cart-plus"></i> Add to Cart
                      </button>
                    </form>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
            <p class="text-center">No medicines available.</p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const params = new URLSearchParams(window.location.search);
  const highlightId = params.get('highlight');
  if (highlightId) {    
    const row = document.getElementById('medicine-' + highlightId);
    
    if (row) {      
      row.classList.add('row-highlight');
      
      const tds = row.querySelectorAll('td');
      
      tds.forEach((td, index) => {
        td.classList.add('medicine-highlight');
      });
      
      row.scrollIntoView({ 
        behavior: 'smooth', 
        block: 'center',
        inline: 'nearest'
      });
      
      setTimeout(() => {
        row.classList.remove('row-highlight');
        tds.forEach(td => td.classList.remove('medicine-highlight'));
      }, 3000);
      
    } else {
      const allRows = document.querySelectorAll('tr[id^="medicine-"]');
      allRows.forEach(row => console.log('Found row:', row.id));
    }
  } else {
    console.log('No highlight parameter in URL');
  }
});

// Quantity control functions
function decreaseQuantity(medicineId) {
  const quantityInput = document.getElementById('quantity-' + medicineId);
  const currentValue = parseInt(quantityInput.value);
  if (currentValue > 1) {
    quantityInput.value = currentValue - 1;
    updateHiddenQuantity(medicineId);
  }
}

function increaseQuantity(medicineId, maxStock) {
  const quantityInput = document.getElementById('quantity-' + medicineId);
  const currentValue = parseInt(quantityInput.value);
  if (currentValue < maxStock) {
    quantityInput.value = currentValue + 1;
    updateHiddenQuantity(medicineId);
  }
}

function updateHiddenQuantity(medicineId) {
  const quantityInput = document.getElementById('quantity-' + medicineId);
  const hiddenQuantity = document.getElementById('hidden-quantity-' + medicineId);
  hiddenQuantity.value = quantityInput.value;
}

// Update hidden quantity when input changes
document.addEventListener('DOMContentLoaded', function() {
  const quantityInputs = document.querySelectorAll('input[id^="quantity-"]');
  quantityInputs.forEach(input => {
    input.addEventListener('change', function() {
      const medicineId = this.id.replace('quantity-', '');
      updateHiddenQuantity(medicineId);
    });
  });
});
</script>
{% endblock %}