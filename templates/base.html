<style>
  body,html{
    margin:0;
    padding: 0;;
    height:100%
  }
</style>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Curelink</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder@1.13.0/dist/Control.Geocoder.css" />

  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
  <script src="https://unpkg.com/leaflet-control-geocoder@1.13.0/dist/Control.Geocoder.js"></script>
  
</head>
<body>
 
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/6.0.0/mdb.min.css" rel="stylesheet" />
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/6.0.0/mdb.min.js"></script>
  {% if user.is_authenticated and user.profile.role == 'hospital_admin' %}
    <!-- Minimal navbar for hospital admin, all content left-aligned -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
      <div class="container-fluid">
        <span class="me-3">{{ user.username }}</span>
        <a href="/logout/" class="btn btn-outline-danger btn-sm">Logout</a>
      </div>
    </nav>
  {% else %}
    <!-- Normal navbar for other users -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
      <div class="container-fluid">
        <a href="{% url 'home' %}" class="navbar-brand">CureLink</a>
        <button class="navbar-toggler" type="button" data-mdb-toggle="collapse" data-mdb-target="#navbarNav"
              aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
              <i class="fas fa-bars"></i>
          </button>
        <div class="collapse navbar-collapse d-flex justify-content-between" id="navbarNav">
          <ul class="navbar-nav">
            <li class="nav-item">
              <a class="nav-link">Welcome <b>{{ user }}</b></a>                        
            </li>
            {% if user.is_authenticated %}
              {% if user.profile.role == 'seller' %}
                <li class="nav-item"><a href="{% url 'logout' %}" class="nav-link">Logout</a></li>
              {% else %}
                <li class="nav-item"><a class="nav-link" href="{% url 'view_doctors' %}">Doctors</a></li>
                <li class="nav-item"><a href="{% url 'user_dashboard' %}" class="nav-link">My Dashboard</a></li>
                <li class="nav-item"><a href="{% url 'logout' %}" class="nav-link">Logout</a></li>
              {% endif %}
            {% else %}
              <li class="nav-item"><a href="{% url 'login' %}" class="nav-link">Login</a></li>
            {% endif %}
          </ul>
          <div class="d-flex align-items-center ms-auto">
            {% if user.is_authenticated and user.profile.role == 'doctor' %}
              <button id="online-toggle-btn" class="btn btn-outline-success mx-1">Go Online</button>
              <script>
              document.addEventListener('DOMContentLoaded', function() {
                var btn = document.getElementById('online-toggle-btn');
                fetch('/api/doctor_video_online_state/')
                  .then(response => response.json())
                  .then(data => {
                    var isOnline = data.online;
                    btn.textContent = isOnline ? 'Go Offline' : 'Go Online';
                    btn.classList.toggle('btn-outline-success', isOnline);
                    btn.classList.toggle('btn-outline-secondary', !isOnline);
                    btn.onclick = function() {
                      fetch('{% url "toggle_video_online" %}', {
                        method: 'POST',
                        headers: {
                          'X-CSRFToken': '{{ csrf_token }}',
                          'Content-Type': 'application/json',
                        },
                      })
                      .then(response => response.json())
                      .then(data => {
                        isOnline = data.online;
                        btn.textContent = isOnline ? 'Go Offline' : 'Go Online';
                        btn.classList.toggle('btn-outline-success', isOnline);
                        btn.classList.toggle('btn-outline-secondary', !isOnline);
                      });
                    };
                  });
              });
              </script>
            {% endif %}
            <a href="#" id="video-consult-btn" class="btn btn-outline-danger mx-1 position-relative" onclick="openVideoConsultationWindow()">
              VIDEO CONSULTATION
              <span id="online-doctor-count" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                0
              </span>
            </a>
            {% if not user.is_authenticated or user.profile.role != 'doctor' %}
              <a href="{% url 'medicines' %}" class="btn btn-outline-primary mx-1">MEDICINES</a>
              <a href="{% url 'tests_page' %}" class="btn btn-outline-success mx-1">TESTS</a>
            {% endif %}
          </div>
        </div>
      </div>
    </nav>
  {% endif %}
  <br>
  <div class="container">
    {% block content %}
    {% endblock %}
  </div>
  <br><br>
  
</body>
<footer class="bg-light text-center">
  <div class="text-center p-3" style="background-color: rgba(0, 0, 0, 0.2);">
    Made by
    <div class="container p-4 d-flex flex-row justify-content-center">
        <div class="col-lg-6 col-md-12 mb-4 m-md-1">
          <h5 class="text-uppercase">Joyjeet Roy</h5>
        </div>
        <div class="col-lg-6 col-md-12 mb-4 m-md-1">
          <h5 class="text-uppercase">Bhaagyesh Sajja</h5>
        </div>
    </div>
  </div>
</footer>
<script>
function openVideoConsultationWindow() {
  window.open('/video/consult/', '_blank', 'width=1200,height=800');
}

// Real-time online doctor count update using WebSocket
(function() {
  var ws_scheme = window.location.protocol === "https:" ? "wss" : "ws";
  var ws_path = ws_scheme + '://' + window.location.host + '/ws/online_doctor_count/';
  var socket = new WebSocket(ws_path);
  socket.onmessage = function(event) {
    var data = JSON.parse(event.data);
    document.getElementById('online-doctor-count').textContent = data.count;
  };
  socket.onclose = function() {
    // Optionally, try to reconnect after a delay
    setTimeout(function() { window.location.reload(); }, 5000);
  };
})();
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  var toggle = document.getElementById('navbarVideoOnlineToggle');
  var statusText = document.getElementById('navbarVideoOnlineStatus');
  if (toggle) {
    toggle.addEventListener('change', function() {
      fetch('{% url "toggle_video_online" %}', {
        method: 'POST',
        headers: {
          'X-CSRFToken': '{{ csrf_token }}',
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ online: toggle.checked })
      })
      .then(response => response.json())
      .then(data => {
        if (data.video_online) {
          statusText.textContent = 'Online';
        } else {
          statusText.textContent = 'Offline';
        }
        location.reload();
      });
    });
  }
});
</script>
</html>