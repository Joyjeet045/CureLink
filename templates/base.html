<style>
  body,html{
    margin:0;
    padding: 0;;
    height:100%
  }
</style>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Curelink</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder@1.13.0/dist/Control.Geocoder.css" />

  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
  <script src="https://unpkg.com/leaflet-control-geocoder@1.13.0/dist/Control.Geocoder.js"></script>
  
</head>
<body>
 
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/6.0.0/mdb.min.css" rel="stylesheet" />
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/6.0.0/mdb.min.js"></script>
  {% if user.is_authenticated and user.profile.role == 'hospital_admin' %}
    <!-- Minimal navbar for hospital admin, all content left-aligned -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
      <div class="container-fluid">
        <span class="me-3">{{ user.username }}</span>
        <a href="/logout/" class="btn btn-outline-danger btn-sm">Logout</a>
      </div>
    </nav>
  {% else %}
    <!-- Normal navbar for other users -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
      <div class="container-fluid">
        <a href="{% url 'home' %}" class="navbar-brand">CureLink</a>
        <button class="navbar-toggler" type="button" data-mdb-toggle="collapse" data-mdb-target="#navbarNav"
              aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
              <i class="fas fa-bars"></i>
          </button>
        <div class="collapse navbar-collapse d-flex justify-content-between" id="navbarNav">
          <ul class="navbar-nav">
            <li class="nav-item">
              <a class="nav-link">Welcome <b>{{ user }}</b></a>                        
            </li>
            {% if user.is_authenticated %}
              {% if user.profile.role == 'seller' %}
                <li class="nav-item"><a href="{% url 'logout' %}" class="nav-link">Logout</a></li>
              {% else %}
                <li class="nav-item"><a class="nav-link" href="{% url 'view_doctors' %}">Doctors</a></li>
                <li class="nav-item"><a href="{% url 'user_dashboard' %}" class="nav-link">My Dashboard</a></li>
                <li class="nav-item"><a href="{% url 'logout' %}" class="nav-link">Logout</a></li>
              {% endif %}
            {% else %}
              <li class="nav-item"><a href="{% url 'login' %}" class="nav-link">Login</a></li>
            {% endif %}
          </ul>
          <div class="d-flex align-items-center ms-auto">
            {% if user.is_authenticated and user.profile.role == 'doctor' %}
              <a href="{% url 'doctor_requests' %}" class="btn btn-outline-info mx-1">
                <i class="fas fa-bell me-1"></i>Requests
              </a>
              <button id="online-toggle-btn" class="btn btn-outline-success mx-1">Go Online</button>
              <script>
              document.addEventListener('DOMContentLoaded', function() {
                var btn = document.getElementById('online-toggle-btn');
                fetch('{% url "doctor_video_online_state" %}')
                  .then(response => response.json())
                  .then(data => {
                    var isOnline = data.online;
                    btn.textContent = isOnline ? 'Go Offline' : 'Go Online';
                    btn.classList.toggle('btn-outline-success', isOnline);
                    btn.classList.toggle('btn-outline-secondary', !isOnline);
                    btn.onclick = function() {
                      fetch('{% url "toggle_video_online" %}', {
                        method: 'POST',
                        headers: {
                          'X-CSRFToken': '{{ csrf_token }}',
                          'Content-Type': 'application/json',
                        },
                      })
                      .then(response => response.json())
                      .then(data => {
                        isOnline = data.online;
                        btn.textContent = isOnline ? 'Go Offline' : 'Go Online';
                        btn.classList.toggle('btn-outline-success', isOnline);
                        btn.classList.toggle('btn-outline-secondary', !isOnline);
                      });
                    };
                  });
              });
              </script>
            {% endif %}
            {% if not user.is_authenticated or user.profile.role != 'doctor' %}
              <a href="#" id="video-consult-btn" class="btn btn-outline-danger mx-1 position-relative">
                VIDEO CONSULTATION
                <span id="online-doctor-count" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                  0
                </span>
              </a>
              <a href="{% url 'medicines' %}" class="btn btn-outline-primary mx-1">MEDICINES</a>
              <a href="{% url 'tests_page' %}" class="btn btn-outline-success mx-1">TESTS</a>
            {% endif %}
          </div>
        </div>
      </div>
    </nav>
  {% endif %}
  <br>
  <div class="container">
    {% block content %}
    {% endblock %}
  </div>
  <br><br>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
<footer class="bg-light text-center">
  <div class="text-center p-3" style="background-color: rgba(0, 0, 0, 0.2);">
    Made by
    <div class="container p-4 d-flex flex-row justify-content-center">
        <div class="col-lg-6 col-md-12 mb-4 m-md-1">
          <h5 class="text-uppercase">Joyjeet Roy</h5>
        </div>
        <div class="col-lg-6 col-md-12 mb-4 m-md-1">
          <h5 class="text-uppercase">Bhaagyesh Sajja</h5>
        </div>
    </div>
  </div>
</footer>
<script>

(function() {
  var ws_scheme = window.location.protocol === "https:" ? "wss" : "ws";
  var ws_path = ws_scheme + '://' + window.location.host + '/ws/online_doctor_count/';
  var socket = new WebSocket(ws_path);
  socket.onmessage = function(event) {
    var data = JSON.parse(event.data);
    document.getElementById('online-doctor-count').textContent = data.count;
  };
  socket.onclose = function() {
    // Optionally, try to reconnect after a delay
    setTimeout(function() { window.location.reload(); }, 5000);
  };
})();
</script>

<!-- Video Consultation Modal -->
<div class="modal fade" id="videoConsultModal" tabindex="-1" aria-labelledby="videoConsultModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form class="modal-content" id="videoConsultForm">
      <div class="modal-header">
        <h5 class="modal-title" id="videoConsultModalLabel">Start Video Consultation</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label for="symptom" class="form-label">Symptom</label>
          <input type="text" class="form-control" id="symptom" name="symptom" required>
        </div>
      </div>
      <div class="modal-footer">
        <button type="submit" class="btn btn-success">Connect!</button>
      </div>
    </form>
  </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', function() {
  var videoBtn = document.getElementById('video-consult-btn');
  if (videoBtn) {
    videoBtn.addEventListener('click', function(e) {
      e.preventDefault();
      var modal = new bootstrap.Modal(document.getElementById('videoConsultModal'));
      modal.show();
    });
  }
  var form = document.getElementById('videoConsultForm');
  if (form) {
    form.onsubmit = function(e) {
      e.preventDefault();
      var symptom = document.getElementById('symptom').value;
      fetch('/submit_symptoms/', {
        method: 'POST',
        headers: {
          'X-CSRFToken': '{{ csrf_token }}',
          'Content-Type': 'application/x-www-form-urlencoded'
        },
        body: 'symptoms=' + encodeURIComponent(symptom)
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Show waiting message instead of immediately opening room
          var modal = bootstrap.Modal.getInstance(document.getElementById('videoConsultModal'));
          modal.hide();
          
          // Show waiting notification
          showWaitingNotification(data.room_id, data.doctors_count, data.specialties);
        } else {
          alert('Error: ' + (data.error || 'No matching doctors found.'));
        }
      });
    };
  }
});
</script>

<!-- Patient Waiting Functions -->
<script>
// Global variables for patient waiting
let patientSocket = null;
let waitingRoomId = null;

function showWaitingNotification(roomId, doctorsCount, specialties) {
  waitingRoomId = roomId;
  
  // Create waiting notification
  const notification = document.createElement('div');
  notification.id = 'waiting-notification';
  notification.className = 'position-fixed top-50 start-50 translate-middle bg-white border rounded shadow-lg p-4';
  notification.style.zIndex = '9999';
  notification.style.minWidth = '400px';
  
  notification.innerHTML = `
    <div class="text-center">
      <div class="spinner-border text-primary mb-3" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <h5 class="mb-3">Waiting for Doctor</h5>
      <p class="text-muted mb-2">Your request has been sent to ${doctorsCount} online doctor(s)</p>
      <p class="text-muted mb-3">Matching specialties: ${specialties.join(', ')}</p>
      <div class="alert alert-info">
        <i class="fas fa-info-circle me-2"></i>
        You will be automatically redirected when a doctor accepts your request.
      </div>
      <button class="btn btn-outline-secondary btn-sm" onclick="cancelRequest()">
        <i class="fas fa-times me-1"></i>Cancel Request
      </button>
    </div>
  `;
  
  document.body.appendChild(notification);
  connectPatientWebSocket(roomId);
}

function connectPatientWebSocket(roomId) {
  const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
  const wsUrl = `${protocol}//${window.location.host}/ws/patient_waiting/${roomId}/`;
  
  patientSocket = new WebSocket(wsUrl);
  
  patientSocket.onopen = function() {
    console.log('Patient WebSocket connected for room:', roomId);
  };
  
  patientSocket.onmessage = function(event) {
    console.log('Patient WebSocket received message:', event.data);
    const data = JSON.parse(event.data);
    if (data.type === 'doctor_accepted') {
      console.log('Doctor accepted request, redirecting to video room');
      hideWaitingNotification();
      window.location.href = '/video-consultation/' + roomId + '/';
    } else if (data.type === 'request_declined') {
      console.log('Request declined by all doctors');
      hideWaitingNotification();
      alert('No doctors are available at the moment. Please try again later.');
    }
  };
  
  patientSocket.onclose = function() {
    console.log('Patient WebSocket disconnected for room:', roomId);
  };
  
  patientSocket.onerror = function(error) {
    console.log('Patient WebSocket error:', error);
  };
}

function hideWaitingNotification() {
  console.log('Hiding waiting notification');
  const notification = document.getElementById('waiting-notification');
  if (notification) {
    notification.remove();
  }
  if (patientSocket) {
    console.log('Closing patient WebSocket connection');
    patientSocket.close();
    patientSocket = null;
  }
  waitingRoomId = null;
}

function cancelRequest() {
  if (patientSocket && waitingRoomId) {
    const cancelMessage = JSON.stringify({
      type: 'cancel_request',
      room_id: waitingRoomId
    });
    patientSocket.send(cancelMessage);
  }
  hideWaitingNotification();
}
</script>
</html>